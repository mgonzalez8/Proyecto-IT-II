name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build & Deploy Stage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      #   - name: Build and push Docker image to ECR
      #     uses: docker/build-push-action@v4
      #     with:
      #       context: .
      #       push: true
      #       tags: |
      #         ${{ steps.login-ecr.outputs.registry }}/app_sugar:dev-latest
      #         ${{ steps.login-ecr.outputs.registry }}/app_sugar:dev-${{ github.sha }}
      #       build-args: |
      #         AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
      #         AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
      #         AWS_BUCKET=${{ secrets.AWS_BUCKET }}
      #         MODEL_FILE=${{ secrets.MODEL_FILE }}
      #         ENV=dev

      #   - name: Deploy to EC2 - DEV (Port 8082)
      #     run: |
      #       ECR_IMAGE=${{ steps.login-ecr.outputs.registry }}/app_sugar:dev-latest
      #       ENV=dev
      #       PORT=8082

      #       echo "Deploying DEV to EC2 instance..."
      #       echo "Environment: $ENV"
      #       echo "Port: $PORT"
      #       echo "ECR Image: $ECR_IMAGE"

      #       # Instalar sshpass para autenticación por contraseña
      #       sudo apt-get update && sudo apt-get install -y sshpass

      #       # Ejecutar comandos de deployment directamente via SSH
      #       sshpass -p "${{ secrets.EC2_PASSWORD }}" ssh \
      #         -o StrictHostKeyChecking=no \
      #         -o UserKnownHostsFile=/dev/null \
      #         ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_COMMANDS'

      #       set -e

      #       # Variables
      #       ENV=dev
      #       PORT=8082
      #       ECR_IMAGE=${{ steps.login-ecr.outputs.registry }}/app_sugar:dev-latest
      #       REGISTRY=${{ steps.login-ecr.outputs.registry }}
      #       REGION=${{ secrets.AWS_REGION }}
      #       AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
      #       AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
      #       AWS_BUCKET=${{ secrets.AWS_BUCKET }}
      #       MODEL_FILE=${{ secrets.MODEL_FILE }}

      #       echo "Starting deployment..."
      #       echo "Environment: $ENV"
      #       echo "Port: $PORT"
      #       echo "ECR Image: $ECR_IMAGE"

      #       # Configurar credenciales de AWS
      #       export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY
      #       export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_KEY
      #       export AWS_DEFAULT_REGION=$REGION

      #       # Descargar las credenciales de ECR y hacer login en Docker
      #       echo "Logging in to ECR..."
      #       aws ecr get-login-password --region $REGION | sudo docker login --username AWS --password-stdin $REGISTRY

      #       # Nombre del contenedor
      #       CONTAINER_NAME="iris_app-dev"

      #       # Detener contenedor anterior si existe
      #       echo "Stopping previous container..."
      #       sudo docker stop $CONTAINER_NAME || true
      #       sudo docker rm $CONTAINER_NAME || true

      #       # Descargar la nueva imagen
      #       echo "Pulling Docker image..."
      #       sudo docker pull $ECR_IMAGE

      #       # Ejecutar contenedor en puerto 8082
      #       echo "Running new container..."
      #       sudo docker run -d \
      #         --name $CONTAINER_NAME \
      #         --restart unless-stopped \
      #         -p $PORT:8501 \
      #         -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY \
      #         -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_KEY \
      #         -e AWS_BUCKET=$AWS_BUCKET \
      #         -e MODEL_FILE=$MODEL_FILE \
      #         -e ENV=$ENV \
      #         -e AWS_DEFAULT_REGION=$REGION \
      #         $ECR_IMAGE

      #       echo "DEV container deployed successfully on port $PORT"

      #       DEPLOY_COMMANDS

      - name: Deployment Complete
        run: echo "✓ DEV deployment completed successfully"
